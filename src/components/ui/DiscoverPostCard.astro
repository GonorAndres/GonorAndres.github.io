---
import { getCollection } from 'astro:content';
import type { Lang } from '../../i18n';
import { t, useTranslatedPath } from '../../i18n';
import { categoryLabels } from '../../data/categories';
import type { Category } from '../../data/categories';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;

const posts = (await getCollection('blog'))
  .filter((p) => p.data.lang === lang)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const latestSlugs = new Set(posts.slice(0, 3).map((p) => p.slug));
const remaining = posts.filter((p) => !latestSlugs.has(p.slug));

// Fisher-Yates shuffle
for (let i = remaining.length - 1; i > 0; i--) {
  const j = Math.floor(Math.random() * (i + 1));
  [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
}

const discoverPosts = remaining.slice(0, 3);
const tp = useTranslatedPath(lang);

function getPostUrl(slug: string) {
  return tp(`/blog/${slug.replace(/^(es|en)\//, '')}/`);
}

function getCategory(category: string) {
  return categoryLabels[lang][category as Category] ?? category;
}

function formatDate(date: string) {
  return new Date(date).toLocaleDateString(lang === 'es' ? 'es-MX' : 'en-US', {
    month: 'short',
    day: 'numeric',
  });
}
---

{discoverPosts.length > 0 ? (
  <>
    {/* Desktop: stacked list */}
    <div class="hidden md:flex flex-col gap-2 w-full fade-up">
      <span class="text-xs font-medium text-sage uppercase tracking-wider mb-1">
        {t(lang, 'hero.discoverPosts')}
      </span>
      {discoverPosts.map((post) => (
        <a
          href={getPostUrl(post.slug)}
          class="flex flex-col gap-1 rounded-lg border border-amber/20 bg-cream/50 backdrop-blur-sm px-4 py-3 hover:border-terracotta/40 hover:shadow-sm transition-all group"
        >
          <div class="flex items-center gap-2">
            <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-sage/15 text-sage font-medium">
              {getCategory(post.data.category)}
            </span>
            <time class="text-xs text-navy/50 ml-auto">{formatDate(post.data.date)}</time>
          </div>
          <span class="font-serif text-sm font-bold text-navy leading-snug line-clamp-2 group-hover:text-terracotta transition-colors">
            {post.data.title}
          </span>
        </a>
      ))}
    </div>

    {/* Mobile: horizontal scrollable */}
    <div class="md:hidden flex flex-col gap-2 fade-up">
      <span class="text-xs font-medium text-sage uppercase tracking-wider mb-1">
        {t(lang, 'hero.discoverPosts')}
      </span>
      {discoverPosts.map((post) => (
        <a
          href={getPostUrl(post.slug)}
          class="flex items-center gap-3 rounded-lg border border-amber/20 bg-cream/50 px-4 py-3 hover:border-terracotta/40 hover:shadow-sm transition-all group"
        >
          <div class="flex-1 min-w-0">
            <span class="font-serif text-sm font-bold text-navy leading-snug line-clamp-1 group-hover:text-terracotta transition-colors">
              {post.data.title}
            </span>
          </div>
          <time class="text-xs text-navy/50 shrink-0">{formatDate(post.data.date)}</time>
        </a>
      ))}
    </div>
  </>
) : (
  <div />
)}
